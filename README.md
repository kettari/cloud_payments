# Плагин CloudPayments
Плагин платёжной системы CloudPayments для [Вебасист](https://www.webasyst.com/) и магазина Shop Script.

Домашняя страница: https://github.com/kettari/cloud_payments

## Описание

Плагин позволяет оплачивать товары и услуги с помощью платёжной системы [CloudPayments](https://cloudpayments.ru/).
Возможности:
* Интеграция платёжной системы с помощью виджета, без дополнительного перехода на другой сайт;
* Соответствие 54-ФЗ: отправка приобретённых позиций в чеке;
* Настройка вариантов налогообложения;
* Одно- и двухстадийная схема списания денежных средств;
* Локализация виджета оплаты.

### Налогообложение
Плагин не учитывает настройку налогообложения по отдельным товарам.

## Установка
Плагин можно установить с помощью Инсталера со [страницы плагина](https://www.webasyst.ru/store/plugin/payment/cloud_payments/) либо вручную из [репозитория](https://github.com/kettari/cloud_payments).

### Автоматическая установка
Автоматическая установка описана в [инструкции](https://support.webasyst.ru/8620/webasyst-store-install-product/) к системе Вебасист.

### Ручная установка
* Скачайте последнюю версию плагина из [репозитория](https://github.com/kettari/cloud_payments/releases).
* Распакуйте архив на своём сервере в папку `\wa-plugins\payment`
> Например, если магазин на вашем сервере установлен в папке `\var\www\shop.yourdomain.com\public`, 
> то плагин должен быть распакован в папку `\var\www\shop.yourdomain.com\public\wa-plugins\payment`
>
> Для проверки, полный путь к основному файлу плагина в примере выше будет:
> `\var\www\shop.yourdomain.com\public\wa-plugins\payment\cloud_payments\lib\cloud_paymentsPayment.class.php`
* Добавьте плагин CloudPayments в настройках вашего магазина как способ оплаты: *Настройки* → *Оплата* → *Добавить способ оплаты* → *CloudPayments*
* Настройте плагин, нажав в списке на пункт *«Конфигурация»*.

## Настройка плагина
Для корректной работы плагина нужно указать несколько опций.

**Внимание:** автор плагина и CloudPayments не несут ответственности за неверную настройку параметров плагина.
Пожалуйста, будьте особенно внимательны при настройке системы налогообложения и тщательно протестируйте
чеки онлайн-кассы, прежде чем перевести свой сайт в «боевой» режим.

* *Public ID* — идентификатор сайта, находится в ЛК CloudPayments. Обычно выглядит как строка символов, начинается с «pk_».
* *API secret* — пароль для API, находится в ЛК CloudPayments в параметре «*Пароль для API*».
* *Схема проведения платежа* — Одностадийная оплата выполняется сразу, двухстадийная требует подтверждения в личном кабинете мерчанта CloudPayments. Подробнее см. [Схемы проведения платежа](https://cloudpayments.ru/Docs/Integration#schemes).
Варианты:
  * Одностадийная
  * Двухстадийная
* *Система налогообложения* — система налогообложения, используемая в юридическом лице от имени которого работает магазин. Варианты:
  * Общая система налогообложения (ОСН)
  * Упрощенная система налогообложения (Доход)
  * Упрощенная система налогообложения (Доход минус Расход)
  * Единый налог на вмененный доход
  * Единый сельскохозяйственный налог
  * Патентная система налогообложения
* *Значение ставки НДС* — если используется «Основная система налогообложения», то какую ставку НДС указывать в чеках онлайн-кассы. При указании ставки НДС будьте внимательны: «НДС 0%» и «НДС не облагается» — это не равнозначные варианты.
Если в параметре «*Система налогообложения*» выбран любой вариант, кроме ОСН, то плагин всегда подставляет в чек вариант «НДС не облагается».
* *Отправлять фискальный чек по 54-ФЗ* — если отмечено, плагин будет запрашивать фискальный чек у CloudPayments. Если 
фискальные чеки не нужны, этот параметр нужно отключить.
* *Требовать email в виджете* — если отмечено, то виджет оплаты будет требовать от клиента указать email при оплате.
* *Локализация виджета* — Укажите язык виджета. От выбора языка так же зависит часовой пояс, используемый для отметок времени. Подробнее см. [Локализация](https://cloudpayments.ru/Docs/Widget#language) 
* *Режим отладки плагина* — В режиме отладки плагин выдаст в броузер дамп данных, необходимых для проверки его работы 
и исправления ошибок. Пожалуйста, прикладывайте эту информацию при обращении к разработчикам по поводу неправильной работы плагина. 

### Настройка уведомлений об оплате
Чтобы магазин узнавал об оплатах товара, в личном кабинете CloudPayments укажите для уведомления Pay адрес из параметра «*URL для Pay уведомлений*» плагина. 
> Например, URL для уведомлений может выглядеть примерно так: `http://www.your-domain.com/payments.php/cloud_payments/`, но это не точно.

# Контакты
Вопросы и предложения пишите в [issues на гитхабе](https://github.com/kettari/cloud_payments/issues).

# Changelog
Все значимые изменения плагина перечислены здесь.

Формат документа основан на рекомендациях [Keep a Changelog](http://keepachangelog.com/en/1.0.0/)
, плагин использует [Семантическое Версионирование](http://semver.org/spec/v2.0.0.html).

## [Неопубликовано]
Смотрите [проект на Гитхабе](https://github.com/kettari/amber/projects/1).

## [1.1.0] - 2018-01-09
### Добавлено
  - [cloud_payments-6](https://github.com/kettari/cloud_payments/issues/6) Добавить выбор языка для виджета
  - [cloud_payments-7](https://github.com/kettari/cloud_payments/issues/7) Добавить опцию выбора одно- либо двухстадийной схемы оплаты
  - [cloud_payments-8](https://github.com/kettari/cloud_payments/issues/8) Добавить опцию указания обязательности email
  
### Изменено
  - [cloud_payments-9](https://github.com/kettari/cloud_payments/issues/9) Передавать в качестве accountId идентификатор клиента из магазина вместо email

## [1.0.9] - 2018-01-04
### Добавлено
  - [cloud_payments-4](https://github.com/kettari/cloud_payments/issues/4) Опция для выключения отправки чеков по 54-ФЗ
  - Опция включения режима отладки плагина
  
### Исправлено
  - [cloud_payments-5](https://github.com/kettari/cloud_payments/issues/5) Учитывать стоимость доставки и скидку в чеке

## [1.0.8] - 2017-12-19
### Изменено
  - Версия плагина обновлена до 1.0.8 в /lib/config/plugin.php

## [1.0.7] - 2017-12-19
### Исправлено
  - [cloud_payments-3](https://github.com/kettari/cloud_payments/issues/3) Проблема в отправке чеков если десятичный разделитель «,» вместо «.»

## [1.0.6] - 2017-07-07
### Исправлено
  - Используем waResponse->addHeader() вместо запрещённой функции header();
  - Убран неиспользуемый файл requirements.php.

## [1.0.5] - 2017-06-26
### Изменено
  - Плагин подготовлен к публикации в каталоге Вебасист

## [1.0.4] - 2017-06-26
### Исправлено
  - Мелкие ошибки

## [1.0.3] - 2017-06-26
### Исправлено
  - Ошибка с отправкой чеков в CloudPayments

## [1.0.2] - 2017-06-26
### Исправлено
  - Ошибка с функцией getallheaders()

## [1.0.1] - 2017-06-26
### Изменено
  - Убраны лишние требования к версии PHP

## [1.0.0] - 2017-06-26
  - Первый релиз